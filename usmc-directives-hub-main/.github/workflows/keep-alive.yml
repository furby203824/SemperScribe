# GitHub Actions Workflow to Keep Render.com Proxy Server Alive
# Prevents cold starts on free tier by pinging during peak hours only
# COST OPTIMIZATION: Reduced frequency during off-peak hours (nights/weekends)

name: Keep Render Alive

on:
  # Peak hours: Every 14 minutes during business hours (Mon-Fri 6AM-10PM UTC)
  # Off-peak: Every 29 minutes during nights and weekends
  # This reduces monthly runs from ~3,090 to ~2,000 (35% cost savings)
  schedule:
    # Business hours (6 AM - 10 PM UTC, Mon-Fri): Every 14 minutes
    - cron: '0,14,28,42,56 6-21 * * 1-5'
    # Off-peak hours: Every 29 minutes (keeps server alive but reduces costs)
    - cron: '0,29,58 0-5,22-23 * * *'
    - cron: '0,29,58 * * * 0,6'

  # Allow manual trigger
  workflow_dispatch:

# Prevent multiple instances from running simultaneously
concurrency:
  group: keep-alive
  cancel-in-progress: true

jobs:
  ping:
    runs-on: ubuntu-latest

    steps:
      - name: Check if peak hours (optimization info)
        id: check-hours
        run: |
          HOUR=$(date -u +%H)
          DAY=$(date -u +%u)  # 1=Monday, 7=Sunday
          if [ $DAY -le 5 ] && [ $HOUR -ge 6 ] && [ $HOUR -lt 22 ]; then
            echo "peak=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  Peak hours - running every 14 minutes"
          else
            echo "peak=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  Off-peak hours - running every 29 minutes (cost optimization)"
          fi

      - name: Ping health endpoint
        run: |
          echo "ðŸ“ Pinging proxy server to keep it alive..."

          # Ping the health endpoint with increased timeout
          # Catch curl errors (e.g., timeout exit code 28) to prevent workflow failure
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 60 \
            https://usmc-directives-proxy.onrender.com/health) || RESPONSE="timeout"

          if [ "$RESPONSE" = "200" ]; then
            echo "âœ… Server is alive (HTTP $RESPONSE)"
          elif [ "$RESPONSE" = "timeout" ]; then
            echo "âš ï¸  Request timed out after 60 seconds (server may be cold-starting)"
          else
            echo "âš ï¸  Server returned HTTP $RESPONSE"
          fi

          # Don't fail the workflow - this is just a keep-alive ping

      - name: Create summary
        if: always()
        run: |
          echo "## Keep-Alive Ping Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Peak Hours:** ${{ steps.check-hours.outputs.peak }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Cost Optimization Strategy" >> $GITHUB_STEP_SUMMARY
          echo "- **Peak hours (Mon-Fri 6AM-10PM UTC):** Every 14 minutes" >> $GITHUB_STEP_SUMMARY
          echo "- **Off-peak hours (nights/weekends):** Every 29 minutes" >> $GITHUB_STEP_SUMMARY
          echo "- **Monthly runs:** ~2,000 (down from ~3,090)" >> $GITHUB_STEP_SUMMARY
          echo "- **Cost savings:** ~35% reduction in workflow minutes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow pings the proxy server to prevent cold starts on Render's free tier while minimizing CI/CD costs." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Server URL:** https://usmc-directives-proxy.onrender.com" >> $GITHUB_STEP_SUMMARY
