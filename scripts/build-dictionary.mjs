
import fs from 'fs/promises';
import path from 'path';

const filesToParse = [
  'docs/SecNav5216/Phrases, Sentences, or Groups of Sentences.md',
  'docs/SecNav5216/Abbreviations, Acronyms, Short Titles.md',
];

const outputFilePath = 'src/lib/military-dictionary.ts';

async function parseTable(content) {
  const lines = content.split('\n');
  const terms = [];
  const rowRegex = /\|(.+?)\|(.+?)\|/;

  for (const line of lines) {
    if (line.includes('---')) continue;
    const match = line.match(rowRegex);
    if (match) {
      const term = match[1].trim().replace(/(\n|\r)/g, ' ').replace(/(\s{2,})/g, ' ').replace(/(\*\*|\*)/g, '');
      const meaning = match[2].trim().replace(/(\n|\r)/g, ' ').replace(/(\s{2,})/g, ' ');
      if (term && meaning && term !== 'PHRASE EQUIVALENT' && term !== 'Full Title' && term !== ':---' && meaning !== ':---') {
        terms.push({ term, meaning });
      }
    }
  }
  return terms;
}

async function buildDictionary() {
  let allTerms = [];
  const projectRoot = process.cwd();

  for (const file of filesToParse) {
    try {
      const filePath = path.join(projectRoot, file);
      const content = await fs.readFile(filePath, 'utf-8');
      const parsedTerms = await parseTable(content);
      allTerms.push(...parsedTerms);
    } catch (error) {
      console.error(`Error processing ${file}:`, error);
    }
  }

  const uniqueTerms = Array.from(new Map(allTerms.map(item => [item.term, item])).values());
  uniqueTerms.sort((a, b) => a.term.localeCompare(b.term));

  const tsContent = `// This file is auto-generated by scripts/build-dictionary.mjs
// Do not edit this file directly.

export interface DictionaryEntry {
  term: string;
  meaning: string;
}

export const militaryDictionary: DictionaryEntry[] = ${JSON.stringify(uniqueTerms, null, 2)};
`;

  try {
    const outputPath = path.join(projectRoot, outputFilePath);
    await fs.writeFile(outputPath, tsContent, 'utf-8');
    console.log(`Successfully built dictionary with ${uniqueTerms.length} terms to ${outputFilePath}`);
  } catch (error) {
    console.error(`Error writing dictionary file:`, error);
  }
}

buildDictionary();
